<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout('代理监控', ~{::div})}">
<body>
    <div>
        <!-- 全局JavaScript函数 -->
        <script th:inline="javascript">
            // 准备编辑模态框的函数
            function prepareEditModal(button) {
                console.log('准备编辑模态框');
                
                // 获取按钮上的数据
                const configId = button.getAttribute('data-config-id');
                const groupName = button.getAttribute('data-group-name');
                const testUrl = button.getAttribute('data-test-url');
                const timeout = button.getAttribute('data-timeout');
                const enabled = button.getAttribute('data-enabled') === 'true';
                
                console.log('配置数据:', { configId, groupName, testUrl, timeout, enabled });
                
                // 设置表单的action
                const form = document.getElementById('editConfigForm');
                form.action = `/proxy-monitor/update/${configId}`;
                
                // 填充表单字段
                document.getElementById('editConfigId').value = configId;
                
                const groupSelect = document.getElementById('editGroupName');
                for (let i = 0; i < groupSelect.options.length; i++) {
                    if (groupSelect.options[i].value === groupName) {
                        groupSelect.selectedIndex = i;
                        break;
                    }
                }
                
                document.getElementById('editTestUrl').value = testUrl;
                document.getElementById('editTimeout').value = timeout;
                document.getElementById('editEnabled').checked = enabled;
            }
        </script>
        
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">代理监控</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addConfigModal">
                    <span data-feather="plus"></span>
                    添加监控配置
                </button>
            </div>
        </div>

        <!-- 监控配置列表 -->
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>代理组</th>
                        <th>测试URL</th>
                        <th>超时(ms)</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:if="${configs.empty}">
                        <td colspan="6" class="text-center">暂无监控配置</td>
                    </tr>
                    <tr th:each="config : ${configs}">
                        <td th:text="${config.id}">1</td>
                        <td th:text="${config.groupName}">Proxy</td>
                        <td th:text="${config.testUrl}">https://www.gstatic.com/generate_204</td>
                        <td th:text="${config.timeout}">5000</td>
                        <td>
                            <span th:if="${config.enabled}" class="badge bg-success">已启用</span>
                            <span th:unless="${config.enabled}" class="badge bg-secondary">已禁用</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" title="编辑" 
                                        data-bs-toggle="modal" data-bs-target="#editConfigModal" 
                                        th:data-config-id="${config.id}"
                                        th:data-group-name="${config.groupName}"
                                        th:data-test-url="${config.testUrl}"
                                        th:data-timeout="${config.timeout}"
                                        th:data-enabled="${config.enabled}"
                                        onclick="prepareEditModal(this)">
                                    <span data-feather="edit"></span>
                                </button>
                                <a th:href="@{/proxy-monitor/history/{groupName}(groupName=${config.groupName})}" class="btn btn-outline-info" title="查看历史记录">
                                    <span data-feather="bar-chart-2"></span>
                                </a>
                                <a th:href="@{/proxy-monitor/toggle/{id}(id=${config.id})}" class="btn btn-outline-warning" th:title="${config.enabled ? '禁用' : '启用'}">
                                    <span data-feather="power"></span>
                                </a>
                                <a th:href="@{/proxy-monitor/delete/{id}(id=${config.id})}" class="btn btn-outline-danger" title="删除" onclick="return confirm('确定要删除此监控配置吗？')">
                                    <span data-feather="trash-2"></span>
                                </a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 添加配置模态框 -->
        <div class="modal fade" id="addConfigModal" tabindex="-1" aria-labelledby="addConfigModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addConfigModalLabel">添加监控配置</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form th:action="@{/proxy-monitor/add}" method="post" th:object="${newConfig}">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <div class="mb-3">
                                <label for="groupName" class="form-label">代理组</label>
                                <select class="form-select" id="groupName" name="groupName" required>
                                    <option value="">-- 选择代理组 --</option>
                                    <option th:each="group : ${availableGroups.keySet()}" th:value="${group}" th:text="${group}">Proxy</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="testUrl" class="form-label">测试URL</label>
                                <input type="text" class="form-control" id="testUrl" name="testUrl" value="https://www.gstatic.com/generate_204" required>
                            </div>
                            <div class="mb-3">
                                <label for="timeout" class="form-label">超时(毫秒)</label>
                                <input type="number" class="form-control" id="timeout" name="timeout" value="5000" required>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="submit" class="btn btn-primary">保存</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 编辑配置模态框 -->
        <div class="modal fade" id="editConfigModal" tabindex="-1" aria-labelledby="editConfigModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editConfigModalLabel">编辑监控配置</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editConfigForm" method="post">
                            <input type="hidden" id="editConfigId" name="id" value="">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            
                            <div class="mb-3">
                                <label for="editGroupName" class="form-label">代理组</label>
                                <select class="form-select" id="editGroupName" name="groupName" required>
                                    <option value="">-- 选择代理组 --</option>
                                    <option th:each="group : ${availableGroups.keySet()}" th:value="${group}" th:text="${group}">Proxy</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editTestUrl" class="form-label">测试URL</label>
                                <input type="text" class="form-control" id="editTestUrl" name="testUrl" value="https://www.gstatic.com/generate_204" required>
                            </div>
                            <div class="mb-3">
                                <label for="editTimeout" class="form-label">超时(毫秒)</label>
                                <input type="number" class="form-control" id="editTimeout" name="timeout" value="5000" required>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="editEnabled" name="enabled">
                                <label class="form-check-label" for="editEnabled">启用</label>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="submit" class="btn btn-primary">保存</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 