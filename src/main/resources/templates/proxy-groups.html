<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout('策略组配置', ~{::div})}">
<body>
    <div>
        <!-- 全局JavaScript函数 -->
        <script th:inline="javascript">
            // 准备编辑模态框的函数
            function prepareEditModal(button) {
                console.log('准备编辑模态框');
                
                // 获取按钮上的数据
                const configId = button.getAttribute('data-config-id');
                const groupName = button.getAttribute('data-group-name');
                const preferredProxy = button.getAttribute('data-preferred-proxy');
                const testUrl = button.getAttribute('data-test-url');
                const timeout = button.getAttribute('data-timeout');
                const maxDelay = button.getAttribute('data-max-delay');
                const maxTimeoutCount = button.getAttribute('data-max-timeout-count');
                const enabled = button.getAttribute('data-enabled') === 'true';
                
                console.log('配置数据:', { configId, groupName, preferredProxy, testUrl, timeout, maxDelay, maxTimeoutCount, enabled });
                
                // 设置表单的action
                const form = document.getElementById('editConfigForm');
                form.action = `/proxy-groups/update/${configId}`;
                
                // 填充表单字段
                document.getElementById('editConfigId').value = configId;
                
                const groupSelect = document.getElementById('editGroupName');
                for (let i = 0; i < groupSelect.options.length; i++) {
                    if (groupSelect.options[i].value === groupName) {
                        groupSelect.selectedIndex = i;
                        break;
                    }
                }
                
                document.getElementById('editTestUrl').value = testUrl;
                document.getElementById('editTimeout').value = timeout;
                document.getElementById('editMaxDelay').value = maxDelay;
                document.getElementById('editMaxTimeoutCount').value = maxTimeoutCount || 3; // 默认值为3
                document.getElementById('editEnabled').checked = enabled;
                
                // 加载代理节点
                setTimeout(() => {
                    loadProxies('edit');
                    
                    // 在代理节点加载完成后，设置选中的代理节点
                    setTimeout(() => {
                        const proxySelect = document.getElementById('editPreferredProxy');
                        for (let i = 0; i < proxySelect.options.length; i++) {
                            if (proxySelect.options[i].value === preferredProxy) {
                                proxySelect.selectedIndex = i;
                                break;
                            }
                        }
                    }, 500);
                }, 100);
            }
            
            // 全局函数，用于加载代理节点
            function loadProxies(mode = 'add') {
                console.log('加载代理节点函数被调用，模式:', mode);
                
                try {
                    // 根据模式选择不同的DOM元素
                    const prefix = mode === 'edit' ? 'edit' : '';
                    console.log('使用前缀:', prefix);
                    
                    // 修正ID大小写问题
                    let groupSelectId, proxySelectId, statusDivId, testUrlId, timeoutId;
                    
                    if (prefix === 'edit') {
                        groupSelectId = 'editGroupName';
                        proxySelectId = 'editPreferredProxy';
                        statusDivId = 'editProxyLoadingStatus';
                        testUrlId = 'editTestUrl';
                        timeoutId = 'editTimeout';
                    } else {
                        groupSelectId = 'groupName';
                        proxySelectId = 'preferredProxy';
                        statusDivId = 'proxyLoadingStatus';
                        testUrlId = 'testUrl';
                        timeoutId = 'timeout';
                    }
                    
                    console.log('尝试获取DOM元素:', groupSelectId, proxySelectId, statusDivId);
                    
                    const groupSelect = document.getElementById(groupSelectId);
                    const proxySelect = document.getElementById(proxySelectId);
                    const statusDiv = document.getElementById(statusDivId);
                    const testUrlInput = document.getElementById(testUrlId);
                    const timeoutInput = document.getElementById(timeoutId);
                    
                    console.log('DOM元素获取结果:', 
                        groupSelect ? '策略组选择框-已找到' : '策略组选择框-未找到', 
                        proxySelect ? '代理选择框-已找到' : '代理选择框-未找到', 
                        statusDiv ? '状态显示区-已找到' : '状态显示区-未找到');
                    
                    if (!groupSelect || !proxySelect || !statusDiv) {
                        console.error('找不到必要的DOM元素', {
                            groupSelectId,
                            proxySelectId,
                            statusDivId,
                            groupSelectExists: !!groupSelect,
                            proxySelectExists: !!proxySelect,
                            statusDivExists: !!statusDiv
                        });
                        // 不再弹出alert，避免用户体验不好
                        return;
                    }
                    
                    const selectedGroup = groupSelect.value;
                    console.log('选中的策略组:', selectedGroup);
                    
                    if (!selectedGroup) {
                        console.warn('未选择策略组，不加载代理节点');
                        return;
                    }
                    
                    console.log('加载策略组的代理节点:', selectedGroup);
                    proxySelect.innerHTML = '<option value="">-- 加载中... --</option>';
                    proxySelect.disabled = true; // 禁用选择框
                    statusDiv.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>正在加载代理节点...';
                    statusDiv.style.color = '#6c757d';
                    
                    const apiUrl = `/api/config/group-proxies/${encodeURIComponent(selectedGroup)}?_=${new Date().getTime()}`;
                    console.log('请求API:', apiUrl);
                    
                    fetch(apiUrl)
                        .then(response => {
                            console.log('API响应状态:', response.status);
                            if (!response.ok) {
                                throw new Error(`API请求失败: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(proxies => {
                            console.log('获取到代理节点:', proxies);
                            proxySelect.innerHTML = '<option value="">-- 选择优先节点 --</option>';
                            
                            if (Array.isArray(proxies) && proxies.length > 0) {
                                // 先添加节点选项，不显示延迟
                                proxies.forEach(proxy => {
                                    const option = document.createElement('option');
                                    option.value = proxy;
                                    option.textContent = proxy;
                                    proxySelect.appendChild(option);
                                });
                                statusDiv.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>正在测试延迟...';
                                
                                // 然后测试延迟
                                testProxyDelays(selectedGroup, testUrlInput, timeoutInput, proxySelect, statusDiv);
                            } else {
                                proxySelect.disabled = false; // 重新启用选择框
                                statusDiv.innerHTML = '未找到代理节点';
                                statusDiv.style.color = '#dc3545';
                            }
                        })
                        .catch(error => {
                            console.error('获取代理节点出错:', error);
                            proxySelect.innerHTML = '<option value="">-- 无法获取代理节点 --</option>';
                            proxySelect.disabled = false; // 重新启用选择框
                            statusDiv.innerHTML = `错误: ${error.message}`;
                            statusDiv.style.color = '#dc3545';
                        });
                } catch (error) {
                    console.error('loadProxies函数执行出错:', error);
                }
            }
            
            // 测试代理延迟的函数
            function testProxyDelays(groupName, testUrlInput, timeoutInput, proxySelect, statusDiv) {
                // 获取测试参数
                const testUrl = testUrlInput ? testUrlInput.value : 'https://www.gstatic.com/generate_204';
                const timeout = timeoutInput ? timeoutInput.value : '5000';
                
                const delayApiUrl = `/api/config/group-delays/${encodeURIComponent(groupName)}?testUrl=${encodeURIComponent(testUrl)}&timeout=${timeout}&_=${new Date().getTime()}`;
                console.log('测试延迟API:', delayApiUrl);
                
                // 在测试延迟期间禁用选择框
                proxySelect.disabled = true;
                
                fetch(delayApiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`延迟测试API请求失败: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(delays => {
                        console.log('获取到延迟数据:', delays);
                        
                        if (delays.error) {
                            statusDiv.innerHTML = '延迟测试失败';
                            statusDiv.style.color = '#dc3545';
                            proxySelect.disabled = false; // 重新启用选择框
                            return;
                        }
                        
                        // 记住当前选中的值
                        const currentSelected = proxySelect.value;
                        
                        // 重新构建选项，包含延迟信息
                        proxySelect.innerHTML = '<option value="">-- 选择优先节点 --</option>';
                        
                        // 按延迟排序（连通的节点在前，断线的在后）
                        const sortedProxies = Object.entries(delays).sort((a, b) => {
                            const [, delayA] = a;
                            const [, delayB] = b;
                            
                            // 断线的节点排在后面
                            if (delayA < 0 && delayB >= 0) return 1;
                            if (delayA >= 0 && delayB < 0) return -1;
                            if (delayA < 0 && delayB < 0) return 0;
                            
                            // 两个都连通的，按延迟升序排列
                            return delayA - delayB;
                        });
                        
                        // 添加带延迟信息的选项
                        let connectedCount = 0;
                        let offlineCount = 0;
                        sortedProxies.forEach(([proxy, delay]) => {
                            const option = document.createElement('option');
                            option.value = proxy;
                            
                            let delayText = '';
                            let statusColor = '';
                            if (delay < 0) {
                                delayText = ' (离线)';
                                statusColor = 'color: #dc3545; font-weight: bold;'; // 红色加粗
                                offlineCount++;
                            } else {
                                delayText = ` (${delay}ms)`;
                                connectedCount++;
                                if (delay <= 100) {
                                    statusColor = 'color: #28a745; font-weight: bold;'; // 绿色加粗
                                } else if (delay <= 300) {
                                    statusColor = 'color: #ffc107; font-weight: bold;'; // 黄色加粗
                                } else {
                                    statusColor = 'color: #fd7e14; font-weight: bold;'; // 橙色加粗
                                }
                            }
                            
                            option.textContent = proxy + delayText;
                            option.style.cssText = statusColor;
                            proxySelect.appendChild(option);
                        });
                        
                        // 恢复之前选中的值
                        if (currentSelected) {
                            proxySelect.value = currentSelected;
                        }
                        
                        // 重新启用选择框
                        proxySelect.disabled = false;
                        
                        statusDiv.innerHTML = `已加载 ${sortedProxies.length} 个代理节点，${connectedCount} 个连通，${offlineCount} 个离线`;
                        statusDiv.style.color = connectedCount > 0 ? '#28a745' : '#dc3545';
                    })
                    .catch(error => {
                        console.error('测试延迟出错:', error);
                        statusDiv.innerHTML = `延迟测试失败: ${error.message}`;
                        statusDiv.style.color = '#dc3545';
                        proxySelect.disabled = false; // 重新启用选择框
                    });
            }
            
            // 刷新延迟的函数
            function refreshDelays(mode = 'add') {
                console.log('手动刷新延迟，模式:', mode);
                
                const prefix = mode === 'edit' ? 'edit' : '';
                const groupSelectId = prefix === 'edit' ? 'editGroupName' : 'groupName';
                const proxySelectId = prefix === 'edit' ? 'editPreferredProxy' : 'preferredProxy';
                const statusDivId = prefix === 'edit' ? 'editProxyLoadingStatus' : 'proxyLoadingStatus';
                const testUrlId = prefix === 'edit' ? 'editTestUrl' : 'testUrl';
                const timeoutId = prefix === 'edit' ? 'editTimeout' : 'timeout';
                
                const groupSelect = document.getElementById(groupSelectId);
                const proxySelect = document.getElementById(proxySelectId);
                const statusDiv = document.getElementById(statusDivId);
                const testUrlInput = document.getElementById(testUrlId);
                const timeoutInput = document.getElementById(timeoutId);
                
                if (!groupSelect || !proxySelect || !statusDiv) {
                    console.error('找不到必要的DOM元素');
                    return;
                }
                
                const selectedGroup = groupSelect.value;
                if (!selectedGroup) {
                    statusDiv.innerHTML = '请先选择策略组';
                    statusDiv.style.color = '#dc3545';
                    return;
                }
                
                statusDiv.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>正在刷新延迟...';
                statusDiv.style.color = '#6c757d';
                
                // 直接测试延迟，不重新加载代理列表
                testProxyDelays(selectedGroup, testUrlInput, timeoutInput, proxySelect, statusDiv);
            }
            
            // 刷新所有策略组当前选择节点的函数
            function refreshCurrentProxies() {
                console.log('开始刷新当前选择节点');
                
                // 找到刷新按钮并显示加载状态
                const refreshBtn = document.querySelector('button[onclick="refreshCurrentProxies()"]');
                if (refreshBtn) {
                    const originalHtml = refreshBtn.innerHTML;
                    refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>刷新中...';
                    refreshBtn.disabled = true;
                    
                    // 恢复按钮状态的函数
                    const restoreButton = () => {
                        refreshBtn.innerHTML = originalHtml;
                        refreshBtn.disabled = false;
                    };
                    
                    fetch('/api/config/current-proxies?_=' + new Date().getTime())
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`API请求失败: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(currentProxies => {
                            console.log('获取到当前选择节点:', currentProxies);
                            
                            if (currentProxies.error) {
                                throw new Error(currentProxies.error);
                            }
                            
                            // 更新表格中的当前选择列
                            updateCurrentProxyColumns(currentProxies);
                            
                            // 显示成功提示
                            showToast('当前选择节点已刷新', 'success');
                            
                            restoreButton();
                        })
                        .catch(error => {
                            console.error('刷新当前选择节点失败:', error);
                            showToast('刷新失败: ' + error.message, 'error');
                            restoreButton();
                        });
                }
            }
            
            // 更新表格中当前选择列的函数
            function updateCurrentProxyColumns(currentProxies) {
                // 获取所有配置行
                const configRows = document.querySelectorAll('tbody tr:not(.empty-row)');
                
                configRows.forEach(row => {
                    const groupNameCell = row.querySelector('td:nth-child(2)');
                    const preferredProxyCell = row.querySelector('td:nth-child(3)');
                    const currentProxyCell = row.querySelector('td:nth-child(4)');
                    
                    if (groupNameCell && preferredProxyCell && currentProxyCell) {
                        const groupName = groupNameCell.textContent.trim();
                        const preferredProxy = preferredProxyCell.textContent.trim();
                        const currentProxy = currentProxies[groupName];
                        
                        if (currentProxy) {
                            let badgeClass = '';
                            if (currentProxy === 'error' || currentProxy === '获取失败') {
                                badgeClass = 'badge bg-danger';
                            } else if (currentProxy === preferredProxy) {
                                badgeClass = 'badge bg-success';
                            } else {
                                badgeClass = 'badge bg-warning';
                            }
                            
                            currentProxyCell.innerHTML = `<span class="${badgeClass}">${currentProxy}</span>`;
                        } else {
                            currentProxyCell.innerHTML = '<span class="badge bg-secondary">未知</span>';
                        }
                    }
                });
            }
            
            // 显示提示消息的函数
            function showToast(message, type = 'info') {
                // 创建提示元素
                const toast = document.createElement('div');
                toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
                toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                toast.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(toast);
                
                // 3秒后自动移除
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 3000);
            }
        </script>
        
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">策略组配置</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshCurrentProxies()" title="刷新当前选择">
                        <span data-feather="refresh-cw"></span>
                        刷新当前选择
                    </button>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addConfigModal">
                    <span data-feather="plus"></span>
                    添加配置
                </button>
            </div>
        </div>

        <!-- 策略组配置列表 -->
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>策略组</th>
                        <th>优先节点</th>
                        <th>当前选择</th>
                        <th>测试URL</th>
                        <th>超时(ms)</th>
                        <th>最大延迟(ms)</th>
                        <th>最大超时次数</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:if="${configs.empty}">
                        <td colspan="10" class="text-center">暂无配置</td>
                    </tr>
                    <tr th:each="config : ${configs}">
                        <td th:text="${config.id}">1</td>
                        <td th:text="${config.groupName}">Proxy</td>
                        <td th:text="${config.preferredProxy}">HK01</td>
                        <td>
                            <span th:if="${currentProxies.containsKey(config.groupName)}" 
                                  th:text="${currentProxies.get(config.groupName)}"
                                  th:class="${currentProxies.get(config.groupName) == config.preferredProxy ? 'badge bg-success' : 'badge bg-warning'}">当前节点</span>
                            <span th:unless="${currentProxies.containsKey(config.groupName)}" class="badge bg-secondary">未知</span>
                        </td>
                        <td th:text="${config.testUrl}">https://www.gstatic.com/generate_204</td>
                        <td th:text="${config.timeout}">5000</td>
                        <td th:text="${config.maxDelay}">500</td>
                        <td th:text="${config.maxTimeoutCount}">3</td>
                        <td>
                            <span th:if="${config.enabled}" class="badge bg-success">已启用</span>
                            <span th:unless="${config.enabled}" class="badge bg-secondary">已禁用</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" title="编辑" 
                                        data-bs-toggle="modal" data-bs-target="#editConfigModal" 
                                        th:data-config-id="${config.id}"
                                        th:data-group-name="${config.groupName}"
                                        th:data-preferred-proxy="${config.preferredProxy}"
                                        th:data-test-url="${config.testUrl}"
                                        th:data-timeout="${config.timeout}"
                                        th:data-max-delay="${config.maxDelay}"
                                        th:data-max-timeout-count="${config.maxTimeoutCount}"
                                        th:data-enabled="${config.enabled}"
                                        onclick="prepareEditModal(this)">
                                    <span data-feather="edit"></span>
                                </button>
                                <a th:href="@{/proxy-groups/toggle/{id}(id=${config.id})}" class="btn btn-outline-warning" th:title="${config.enabled ? '禁用' : '启用'}">
                                    <span data-feather="power"></span>
                                </a>
                                <a th:href="@{/proxy-groups/delete/{id}(id=${config.id})}" class="btn btn-outline-danger" title="删除" onclick="return confirm('确定要删除此配置吗？')">
                                    <span data-feather="trash-2"></span>
                                </a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 添加配置模态框 -->
        <div class="modal fade" id="addConfigModal" tabindex="-1" aria-labelledby="addConfigModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addConfigModalLabel">添加策略组配置</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form th:action="@{/proxy-groups/add}" method="post" th:object="${newConfig}">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <div class="mb-3">
                                <label for="groupName" class="form-label">策略组</label>
                                <select class="form-select" id="groupName" name="groupName" required onchange="loadProxies();">
                                    <option value="">-- 选择策略组 --</option>
                                    <option th:each="group : ${availableGroups.keySet()}" th:value="${group}" th:text="${group}">Proxy</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="preferredProxy" class="form-label">优先节点</label>
                                <div class="input-group">
                                    <select class="form-select" id="preferredProxy" name="preferredProxy" required>
                                        <option value="">-- 请先选择策略组 --</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-secondary" onclick="refreshDelays('add')" title="刷新延迟">
                                        <span data-feather="refresh-cw"></span>
                                    </button>
                                </div>
                                <div id="proxyLoadingStatus" class="form-text text-info"></div>
                            </div>
                            <div class="mb-3">
                                <label for="testUrl" class="form-label">测试URL</label>
                                <input type="text" class="form-control" id="testUrl" name="testUrl" value="https://www.gstatic.com/generate_204" required>
                            </div>
                            <div class="mb-3">
                                <label for="timeout" class="form-label">超时(毫秒)</label>
                                <input type="number" class="form-control" id="timeout" name="timeout" value="5000" required>
                            </div>
                            <div class="mb-3">
                                <label for="maxDelay" class="form-label">最大可接受延迟(毫秒)</label>
                                <input type="number" class="form-control" id="maxDelay" name="maxDelay" value="500" required>
                            </div>
                            <div class="mb-3">
                                <label for="maxTimeoutCount" class="form-label">最大超时次数</label>
                                <input type="number" class="form-control" id="maxTimeoutCount" name="maxTimeoutCount" value="3" required min="1">
                                <div class="form-text">连续超时次数达到此值时才会切换节点</div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="submit" class="btn btn-primary">保存</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 编辑配置模态框 -->
        <div class="modal fade" id="editConfigModal" tabindex="-1" aria-labelledby="editConfigModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editConfigModalLabel">编辑策略组配置</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editConfigForm" method="post">
                            <input type="hidden" id="editConfigId" name="id" value="">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            
                            <div class="mb-3">
                                <label for="editGroupName" class="form-label">策略组</label>
                                <select class="form-select" id="editGroupName" name="groupName" required onchange="loadProxies('edit');">
                                    <option value="">-- 选择策略组 --</option>
                                    <option th:each="group : ${availableGroups.keySet()}" th:value="${group}" th:text="${group}">Proxy</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editPreferredProxy" class="form-label">优先节点</label>
                                <div class="input-group">
                                    <select class="form-select" id="editPreferredProxy" name="preferredProxy" required>
                                        <option value="">-- 请先选择策略组 --</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-secondary" onclick="refreshDelays('edit')" title="刷新延迟">
                                        <span data-feather="refresh-cw"></span>
                                    </button>
                                </div>
                                <div id="editProxyLoadingStatus" class="form-text text-info"></div>
                            </div>
                            <div class="mb-3">
                                <label for="editTestUrl" class="form-label">测试URL</label>
                                <input type="text" class="form-control" id="editTestUrl" name="testUrl" value="https://www.gstatic.com/generate_204" required>
                            </div>
                            <div class="mb-3">
                                <label for="editTimeout" class="form-label">超时(毫秒)</label>
                                <input type="number" class="form-control" id="editTimeout" name="timeout" value="5000" required>
                            </div>
                            <div class="mb-3">
                                <label for="editMaxDelay" class="form-label">最大可接受延迟(毫秒)</label>
                                <input type="number" class="form-control" id="editMaxDelay" name="maxDelay" value="500" required>
                            </div>
                            <div class="mb-3">
                                <label for="editMaxTimeoutCount" class="form-label">最大超时次数</label>
                                <input type="number" class="form-control" id="editMaxTimeoutCount" name="maxTimeoutCount" value="3" required min="1">
                                <div class="form-text">连续超时次数达到此值时才会切换节点</div>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="editEnabled" name="enabled">
                                <label class="form-check-label" for="editEnabled">启用</label>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="submit" class="btn btn-primary">保存</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM加载完成，初始化事件监听...');

            // 确保模态框相关的事件监听器设置正确
            const setupModalEvents = () => {
                console.log('设置模态框事件...');
                
                // 添加配置模态框
                const addConfigModal = document.getElementById('addConfigModal');
                if (addConfigModal) {
                    console.log('找到添加配置模态框，设置事件监听');
                    
                    addConfigModal.addEventListener('shown.bs.modal', function() {
                        console.log('添加配置模态框已显示');
                        
                        // 重置选择框
                        const groupSelect = document.getElementById('groupName');
                        const proxySelect = document.getElementById('preferredProxy');
                        const statusDiv = document.getElementById('proxyLoadingStatus');
                        
                        console.log('重置前的DOM元素状态:', {
                            groupSelectExists: !!groupSelect,
                            proxySelectExists: !!proxySelect,
                            statusDivExists: !!statusDiv
                        });
                        
                        if (groupSelect) groupSelect.selectedIndex = 0;
                        if (proxySelect) proxySelect.innerHTML = '<option value="">-- 请先选择策略组 --</option>';
                        if (statusDiv) statusDiv.textContent = '';
                    });
                } else {
                    console.warn('未找到添加配置模态框');
                }
                
                // 编辑配置模态框
                const editConfigModal = document.getElementById('editConfigModal');
                if (editConfigModal) {
                    console.log('找到编辑配置模态框，设置事件监听');
                    
                    editConfigModal.addEventListener('shown.bs.modal', function() {
                        console.log('编辑配置模态框已显示');
                        
                        // 确保编辑模态框中的元素已正确加载
                        setTimeout(() => {
                            const editGroupSelect = document.getElementById('editGroupName');
                            if (editGroupSelect && editGroupSelect.value) {
                                console.log('编辑模态框中已有选中的策略组，加载代理节点');
                                loadProxies('edit');
                            }
                        }, 300);
                    });
                } else {
                    console.warn('未找到编辑配置模态框');
                }
            };
            
            // 页面加载完成后执行初始化
            setTimeout(() => {
                console.log('执行页面初始化...');
                setupModalEvents();
                
                // 检查是否有默认选中的策略组
                const groupSelect = document.getElementById('groupName');
                if (groupSelect && groupSelect.value) {
                    console.log('页面加载完成后发现已有选中的策略组，自动加载代理节点');
                    loadProxies();
                }
            }, 500);
        });
    </script>
</body>
</html>