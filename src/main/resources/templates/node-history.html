<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout('节点延迟详情', ~{::div})}">
<body>
    <div>
        <!-- 引入ECharts -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
        
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2" th:text="${nodeName + ' - 延迟详情'}">节点延迟详情</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadChartData(30)">最近30天</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadChartData(7)">最近7天</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadChartData(3)">最近3天</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadChartData(1)">最近1天</button>
                </div>
                <a th:href="@{'/proxy-monitor/history/' + ${groupName}}" class="btn btn-sm btn-outline-primary">
                    <span data-feather="arrow-left"></span>
                    返回代理组
                </a>
            </div>
        </div>

        <!-- 节点信息 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">节点信息</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <p><strong>代理组名称:</strong> <span th:text="${groupName}">Proxy</span></p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>节点名称:</strong> <span th:text="${nodeName}">Node</span></p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>测试URL:</strong> <span th:text="${config.testUrl}">https://www.gstatic.com/generate_204</span></p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>超时:</strong> <span th:text="${config.timeout}">5000</span>ms</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计信息 -->
        <div id="nodeStatsContainer" class="row mb-4">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">加载节点统计信息...</p>
            </div>
        </div>

        <!-- 延迟趋势图表 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">延迟趋势图</h5>
                        <div id="trendChart" style="height: 400px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 连通性状态图表 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">连通性状态图</h5>
                        <div id="connectivityChart" style="height: 300px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 延迟分布图表 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">延迟分布直方图</h5>
                        <div id="distributionChart" style="height: 300px; width: 100%;"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">每日平均延迟</h5>
                        <div id="dailyAverageChart" style="height: 300px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详细数据表格 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">详细历史数据</h5>
                        <div class="table-responsive">
                            <table id="historyTable" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>延迟 (ms)</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <tr>
                                        <td colspan="3" class="text-center">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <nav id="paginationNav" aria-label="页面导航" style="display: none;">
                            <ul class="pagination justify-content-center">
                                <!-- 分页将在这里动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            // 获取页面参数
            const groupName = /*[[${groupName}]]*/ 'Proxy';
            const nodeName = /*[[${nodeName}]]*/ 'Node';
            let currentDays = 7;
            let nodeData = null;
            let charts = {};
            let currentPage = 1;
            const pageSize = 50;
            
            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', function() {
                loadChartData(7); // 默认加载7天数据
            });
            
            // 加载图表数据
            function loadChartData(days) {
                currentDays = days;
                const url = `/proxy-monitor/api/node-history-data?group=${encodeURIComponent(groupName)}&node=${encodeURIComponent(nodeName)}&days=${days}`;
                
                // 显示加载中状态
                document.getElementById('nodeStatsContainer').innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">加载节点统计信息...</p>
                    </div>
                `;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        nodeData = data;
                        createNodeStats(data);
                        createTrendChart(data);
                        createConnectivityChart(data);
                        createDistributionChart(data);
                        createDailyAverageChart(data);
                        loadHistoryTable(1);
                    })
                    .catch(error => {
                        console.error('获取节点历史数据失败:', error);
                        alert('获取节点历史数据失败: ' + error.message);
                    });
            }
            
            // 创建节点统计信息
            function createNodeStats(data) {
                const statsContainer = document.getElementById('nodeStatsContainer');
                const stats = calculateDetailedStats(data.delayValues);
                
                statsContainer.innerHTML = `
                    <div class="col-md-2 mb-3">
                        <div class="card text-center ${stats.connectivityRate < 80 ? 'border-danger' : 'border-success'}">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${stats.connectivityRate}%</h5>
                                <p class="card-text">连通率</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-success">${stats.avgDelay}</h5>
                                <p class="card-text">平均延迟</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-info">${stats.minDelay}</h5>
                                <p class="card-text">最小延迟</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-warning">${stats.maxDelay}</h5>
                                <p class="card-text">最大延迟</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-secondary">${stats.medianDelay}</h5>
                                <p class="card-text">中位数延迟</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-dark">${stats.totalRecords}</h5>
                                <p class="card-text">总记录数</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 计算详细统计信息
            function calculateDetailedStats(delayValues) {
                const connectedValues = delayValues.filter(v => v >= 0);
                const connectivityRate = Math.round((connectedValues.length / delayValues.length) * 100);
                
                if (connectedValues.length === 0) {
                    return {
                        connectivityRate: 0,
                        avgDelay: 'N/A',
                        minDelay: 'N/A',
                        maxDelay: 'N/A',
                        medianDelay: 'N/A',
                        totalRecords: delayValues.length
                    };
                }
                
                connectedValues.sort((a, b) => a - b);
                const avgDelay = Math.round(connectedValues.reduce((a, b) => a + b, 0) / connectedValues.length);
                const minDelay = Math.min(...connectedValues);
                const maxDelay = Math.max(...connectedValues);
                const medianDelay = connectedValues.length % 2 === 0 
                    ? Math.round((connectedValues[connectedValues.length / 2 - 1] + connectedValues[connectedValues.length / 2]) / 2)
                    : connectedValues[Math.floor(connectedValues.length / 2)];
                
                return {
                    connectivityRate,
                    avgDelay: avgDelay + 'ms',
                    minDelay: minDelay + 'ms',
                    maxDelay: maxDelay + 'ms',
                    medianDelay: medianDelay + 'ms',
                    totalRecords: delayValues.length
                };
            }
            
            // 创建延迟趋势图
            function createTrendChart(data) {
                if (charts.trendChart) {
                    charts.trendChart.dispose();
                }
                
                const chart = echarts.init(document.getElementById('trendChart'));
                
                const chartData = data.timeLabels.map((time, index) => {
                    return [new Date(time).getTime(), data.delayValues[index]];
                });
                
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            // 转换为中国时区显示
                            const date = new Date(params[0].value[0]);
                            const chinaTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
                            const time = chinaTime.toLocaleString('zh-CN');
                            const value = params[0].value[1];
                            if (value < 0) {
                                return `${time}<br/>状态: 未连通`;
                            } else {
                                return `${time}<br/>延迟: ${value}ms`;
                            }
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    dataZoom: [{
                        type: 'inside',
                        start: 0,
                        end: 100
                    }, {
                        start: 0,
                        end: 100
                    }],
                    xAxis: {
                        type: 'time',
                        axisLabel: {
                            formatter: function(value) {
                                const date = new Date(value);
                                const chinaTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
                                if (currentDays <= 1) {
                                    return chinaTime.getHours() + ':' + String(chinaTime.getMinutes()).padStart(2, '0');
                                } else {
                                    return (chinaTime.getMonth() + 1) + '-' + chinaTime.getDate() + ' ' + chinaTime.getHours() + ':' + String(chinaTime.getMinutes()).padStart(2, '0');
                                }
                            }
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '延迟 (ms)',
                        axisLabel: {
                            formatter: function(value) {
                                if (value < 0) return '未连通';
                                return value;
                            }
                        }
                    },
                    series: [{
                        name: '延迟',
                        type: 'line',
                        data: chartData,
                        lineStyle: {
                            width: 2,
                            color: '#5470c6'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [{
                                    offset: 0, color: 'rgba(84, 112, 198, 0.5)'
                                }, {
                                    offset: 1, color: 'rgba(84, 112, 198, 0.05)'
                                }]
                            }
                        }
                    }]
                };
                
                chart.setOption(option);
                charts.trendChart = chart;
            }
            
            // 创建连通性状态图
            function createConnectivityChart(data) {
                if (charts.connectivityChart) {
                    charts.connectivityChart.dispose();
                }
                
                const chart = echarts.init(document.getElementById('connectivityChart'));
                
                const chartData = data.timeLabels.map((time, index) => {
                    return [new Date(time).getTime(), data.delayValues[index] >= 0 ? 1 : 0];
                });
                
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            // 转换为中国时区显示
                            const date = new Date(params[0].value[0]);
                            const chinaTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
                            const time = chinaTime.toLocaleString('zh-CN');
                            const status = params[0].value[1] === 1 ? '连通' : '未连通';
                            return `${time}<br/>状态: ${status}`;
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'time',
                        axisLabel: {
                            formatter: function(value) {
                                const date = new Date(value);
                                const chinaTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
                                if (currentDays <= 1) {
                                    return chinaTime.getHours() + ':' + String(chinaTime.getMinutes()).padStart(2, '0');
                                } else {
                                    return (chinaTime.getMonth() + 1) + '-' + chinaTime.getDate() + ' ' + chinaTime.getHours() + ':' + String(chinaTime.getMinutes()).padStart(2, '0');
                                }
                            }
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '连通状态',
                        min: 0,
                        max: 1,
                        axisLabel: {
                            formatter: function(value) {
                                return value === 1 ? '连通' : '断开';
                            }
                        }
                    },
                    series: [{
                        name: '连通状态',
                        type: 'line',
                        data: chartData,
                        step: 'middle',
                        lineStyle: {
                            width: 3
                        },
                        itemStyle: {
                            color: function(params) {
                                return params.value[1] === 1 ? '#52c41a' : '#ff4d4f';
                            }
                        },
                        areaStyle: {
                            color: function(params) {
                                return params.value[1] === 1 ? 'rgba(82, 196, 26, 0.3)' : 'rgba(255, 77, 79, 0.3)';
                            }
                        }
                    }]
                };
                
                chart.setOption(option);
                charts.connectivityChart = chart;
            }
            
            // 创建延迟分布直方图
            function createDistributionChart(data) {
                if (charts.distributionChart) {
                    charts.distributionChart.dispose();
                }
                
                const chart = echarts.init(document.getElementById('distributionChart'));
                
                const connectedValues = data.delayValues.filter(v => v >= 0);
                if (connectedValues.length === 0) {
                    document.getElementById('distributionChart').innerHTML = '<div class="alert alert-info">没有连通数据</div>';
                    return;
                }
                
                // 计算直方图数据
                const bins = 20;
                const minDelay = Math.min(...connectedValues);
                const maxDelay = Math.max(...connectedValues);
                const binSize = (maxDelay - minDelay) / bins;
                const histogram = new Array(bins).fill(0);
                const binLabels = [];
                
                for (let i = 0; i < bins; i++) {
                    const start = Math.round(minDelay + i * binSize);
                    const end = Math.round(minDelay + (i + 1) * binSize);
                    binLabels.push(`${start}-${end}ms`);
                }
                
                connectedValues.forEach(value => {
                    const binIndex = Math.min(Math.floor((value - minDelay) / binSize), bins - 1);
                    histogram[binIndex]++;
                });
                
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            return `${params[0].name}<br/>数量: ${params[0].value}`;
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: binLabels,
                        axisLabel: {
                            rotate: 45
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '数量'
                    },
                    series: [{
                        name: '延迟分布',
                        type: 'bar',
                        data: histogram,
                        itemStyle: {
                            color: '#91cc75'
                        }
                    }]
                };
                
                chart.setOption(option);
                charts.distributionChart = chart;
            }
            
            // 创建每日平均延迟图
            function createDailyAverageChart(data) {
                if (charts.dailyAverageChart) {
                    charts.dailyAverageChart.dispose();
                }
                
                const chart = echarts.init(document.getElementById('dailyAverageChart'));
                
                // 按日期分组计算平均延迟
                const dailyData = {};
                data.timeLabels.forEach((time, index) => {
                    // 转换为中国时区
                    const date = new Date(time);
                    const chinaTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
                    const dateString = chinaTime.toDateString();
                    const delay = data.delayValues[index];
                    
                    if (!dailyData[dateString]) {
                        dailyData[dateString] = [];
                    }
                    if (delay >= 0) {
                        dailyData[dateString].push(delay);
                    }
                });
                
                const chartData = Object.entries(dailyData).map(([date, delays]) => {
                    const avgDelay = delays.length > 0 ? Math.round(delays.reduce((a, b) => a + b, 0) / delays.length) : 0;
                    return [new Date(date).getTime(), avgDelay];
                }).sort((a, b) => a[0] - b[0]);
                
                const option = {
                    tooltip: {
                        trigger: 'axis',
                        formatter: function(params) {
                            // 转换为中国时区显示
                            const date = new Date(params[0].value[0]);
                            const chinaTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
                            const dateString = chinaTime.toDateString();
                            const avgDelay = params[0].value[1];
                            return `${dateString}<br/>平均延迟: ${avgDelay}ms`;
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'time',
                        axisLabel: {
                            formatter: function(value) {
                                const date = new Date(value);
                                const chinaTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
                                return (chinaTime.getMonth() + 1) + '-' + chinaTime.getDate();
                            }
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '平均延迟 (ms)'
                    },
                    series: [{
                        name: '每日平均延迟',
                        type: 'bar',
                        data: chartData,
                        itemStyle: {
                            color: '#fac858'
                        }
                    }]
                };
                
                chart.setOption(option);
                charts.dailyAverageChart = chart;
            }
            
            // 加载历史数据表格
            function loadHistoryTable(page) {
                currentPage = page;
                const tableBody = document.getElementById('historyTableBody');
                
                if (!nodeData) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center">没有数据</td></tr>';
                    return;
                }
                
                // 创建倒序索引数组，最新的数据在前面
                const totalLength = nodeData.timeLabels.length;
                const startIndex = (page - 1) * pageSize;
                const endIndex = Math.min(startIndex + pageSize, totalLength);
                
                let tableRows = '';
                for (let i = startIndex; i < endIndex; i++) {
                    // 使用倒序索引：最新的数据（最大索引）排在前面
                    const reverseIndex = totalLength - 1 - i;
                    
                    // 将时间转换为中国时区显示
                    const timeString = nodeData.timeLabels[reverseIndex];
                    const date = new Date(timeString);
                    const chinaTime = new Date(date.toLocaleString("en-US", {timeZone: "Asia/Shanghai"}));
                    const time = chinaTime.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    const delay = nodeData.delayValues[reverseIndex];
                    const status = delay >= 0 ? '连通' : '未连通';
                    const delayText = delay >= 0 ? delay + 'ms' : '-';
                    const statusClass = delay >= 0 ? 'text-success' : 'text-danger';
                    
                    tableRows += `
                        <tr>
                            <td>${time}</td>
                            <td>${delayText}</td>
                            <td><span class="${statusClass}">${status}</span></td>
                        </tr>
                    `;
                }
                
                tableBody.innerHTML = tableRows;
                
                // 创建分页导航
                createPagination(nodeData.timeLabels.length);
            }
            
            // 创建分页导航
            function createPagination(totalRecords) {
                const totalPages = Math.ceil(totalRecords / pageSize);
                const paginationNav = document.getElementById('paginationNav');
                
                if (totalPages <= 1) {
                    paginationNav.style.display = 'none';
                    return;
                }
                
                paginationNav.style.display = 'block';
                const pagination = paginationNav.querySelector('.pagination');
                
                let paginationHtml = '';
                
                // 上一页
                if (currentPage > 1) {
                    paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadHistoryTable(${currentPage - 1})">上一页</a></li>`;
                } else {
                    paginationHtml += `<li class="page-item disabled"><span class="page-link">上一页</span></li>`;
                }
                
                // 页码
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    if (i === currentPage) {
                        paginationHtml += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                    } else {
                        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadHistoryTable(${i})">${i}</a></li>`;
                    }
                }
                
                // 下一页
                if (currentPage < totalPages) {
                    paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadHistoryTable(${currentPage + 1})">下一页</a></li>`;
                } else {
                    paginationHtml += `<li class="page-item disabled"><span class="page-link">下一页</span></li>`;
                }
                
                pagination.innerHTML = paginationHtml;
            }
            
            // 响应式调整
            window.addEventListener('resize', function() {
                for (const chartName in charts) {
                    if (charts[chartName] && !charts[chartName].isDisposed()) {
                        charts[chartName].resize();
                    }
                }
            });
        </script>
    </div>
</body>
</html> 